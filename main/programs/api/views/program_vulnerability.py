from django.utils.translation import ugettext as _
from drf_yasg.utils import swagger_auto_schema
from rest_framework.mixins import ListModelMixin
from rest_framework.parsers import MultiPartParser, FormParser, JSONParser
from rest_framework.permissions import IsAuthenticated
from rest_framework.viewsets import GenericViewSet

from main.core.api_base import APIResponseBase
from main.core.utils import paginate, get_query
from ..serializers import ProgramVulnerabilitySerializer, ProgramVulnerabilityListSerializer
from ...models import ProgramVulnerability


class ProgramVulnerabilityView(GenericViewSet, ListModelMixin, APIResponseBase):
    permission_classes = [IsAuthenticated, ]
    parser_classes = [MultiPartParser, FormParser, JSONParser]
    queryset = ProgramVulnerability.objects.all()
    serializer_class = ProgramVulnerabilitySerializer
    lookup_field = "guid"
    http_method_names = ['get', ]

    def get_queryset(self):
        return ProgramVulnerability.objects.all()

    @swagger_auto_schema(query_serializer=ProgramVulnerabilityListSerializer)
    def list(self, request, *args, **kwargs):
        search = request.query_params.get("search")
        page = request.query_params.get("page")
        per_page = request.query_params.get("per_page", 10)
        queryset = self.filter_queryset(self.get_queryset())
        if search:
            entry_query = get_query(search, ("name",))
            queryset = queryset.filter(entry_query)
        record_counts = queryset.count()
        queryset = paginate(queryset, per_page=per_page, page=page)
        serializer = self.get_serializer(queryset, many=True)
        return self.success(code=200, message=_("OK"), data=dict(record_counts=record_counts, queryset=serializer.data))
